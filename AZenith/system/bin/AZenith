#!/system/bin/sh

#
# Copyright (C) 2024-2025 Zexshia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Directories
BASEDIR="/data/adb/modules/AZenith"
INT="/data/AZenith"
RWD="$INT"
MSC="$BASEDIR"
SEARCH_PATHS="/vendor/lib64/egl /vendor/lib64/hw"
PROCESSED_FILE_LIST="$RWD/processed_files.txt"
LOGFILE="/data/AZenith/AZenith.log"
LOGFILEMON="/data/AZenith/AZenithMon.log"
LOGFILEPR="/data/AZenith/AZenithPR.log"
PRELOAD_ENABLED="/data/AZenith/APreload"
# Preload Important Libs
GAME_LIBS='libunity\.so|libUE4\.so|libframeestimation\(VK\|GL\)\.so|libflutter\.so|libapp\.so|libGGP\.so|libGame\.so|libvirglrenderer\.so|libvortekrenderer\.so|libwinlator\.so|libminecraftpe\.so|libc\+\+_shared\.so|libnative-mvd-render\.so|libMiHoYoMTRSDK\.so|libil2cpp\.so|libmoba\.so|libResources\.so|libyuanshen\.so|libcri\_(vip\|ware)\_unity\.so|libgamemaster\.so|LibPixUI\_PXplugin\.so|LibVkLayer\_swapchain\_rotate\.so|libzstd\.so|libPixUI\_Unity\.so'
# Generate Game List Filter
game_list_filter="com.example.gamelist1|com.example.gamelist2$(awk '!/^[[:space:]]*$/ && !/^#/ && !(/[[:alnum:]]+[[:space:]]+[[:alnum:]]+[[:space:]]+[[:alnum:]]+/) {sub("-e ", ""); printf "|%s", $0}' "/data/AZenith/gamelist.txt")"
profiler="$(cat /data/AZenith/profiler)"
# Ensure necessary directories and files for Preloading Exist
[ ! -e "$RWD/gamelist.txt" ] && cp -f "$MSC/gamelist.txt" "$RWD"
touch "$PROCESSED_FILE_LIST"

######################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

# Manage Logging
rm -f "$LOGFILE"
rm -f "$LOGFILEMON"
touch "$LOGFILEMON"
touch "$LOGFILE"
rm -f "$LOGFILEPR"
touch "$LOGFILEPR"
startlogging() {
    echo "****************************************************" >> "$LOGFILE"
    echo "AZenith Log" >> "$LOGFILE"
    echo "" >> "$LOGFILE"
    echo "AZenith Version: $(awk -F'=' '/version=/ {print $2}' /data/adb/modules/AZenith/module.prop)" >> "$LOGFILE"
    echo "Chipset: $(getprop "ro.board.platform")" >> "$LOGFILE"
    echo "Fingerprint: $(getprop ro.build.fingerprint)" >> "$LOGFILE"
    echo "Android SDK: $(getprop ro.build.version.sdk)" >> "$LOGFILE"
    echo "Kernel: $(uname -r -m)" >> "$LOGFILE"
    echo "****************************************************" >> "$LOGFILE"
    echo "" >> "$LOGFILE"
    echo "" >> "$LOGFILE"
}
startloggingmon() {
    echo "****************************************************" >> "$LOGFILEMON"
    echo "AZenith Monitoring Log" >> "$LOGFILEMON"
    echo "" >> "$LOGFILEMON"
    echo "AZenith Version: $(awk -F'=' '/version=/ {print $2}' /data/adb/modules/AZenith/module.prop)" >> "$LOGFILEMON"
    echo "Chipset: $(getprop "ro.board.platform")" >> "$LOGFILEMON"
    echo "Fingerprint: $(getprop ro.build.fingerprint)" >> "$LOGFILEMON"
    echo "Android SDK: $(getprop ro.build.version.sdk)" >> "$LOGFILEMON"
    echo "Kernel: $(uname -r -m)" >> "$LOGFILEMON"
    echo "****************************************************" >> "$LOGFILEMON"
    echo "" >> "$LOGFILEMON"
    echo "" >> "$LOGFILEMON"
    echo "$(date +'%Y-%m-%d %H:%M:%S') - Waiting Daemon to Run..." >> "$LOGFILEMON"
}
startloggingpr() {
    echo "****************************************************" >> "$LOGFILEPR"
    echo "AZenith Preloading Log" >> "$LOGFILEPR"
    echo "" >> "$LOGFILEPR"
    echo "AZenith Version: $(awk -F'=' '/version=/ {print $2}' /data/adb/modules/AZenith/module.prop)" >> "$LOGFILEPR"
    echo "Chipset: $(getprop "ro.board.platform")" >> "$LOGFILEPR"
    echo "Fingerprint: $(getprop ro.build.fingerprint)" >> "$LOGFILEPR"
    echo "Android SDK: $(getprop ro.build.version.sdk)" >> "$LOGFILEPR"
    echo "Kernel: $(uname -r -m)" >> "$LOGFILEPR"
    echo "****************************************************" >> "$LOGFILEPR"
    echo "" >> "$LOGFILEPR"
    echo "" >> "$LOGFILEPR"
}
if [ "$(cat /data/AZenith/logger)" = "1" ]; then
    startlogging
    startloggingpr
    startloggingmon
fi
    
# Notification 
notificationpr() {
    su -lp 2000 -c "/system/bin/cmd notification post -t \"$1\" -i file:///data/local/tmp/AZenith_icon.png -I file:///data/local/tmp/AZenith_icon.png 'AZPreload' \"$2\""
}
notification() {
    su -lp 2000 -c "/system/bin/cmd notification post -t \"$1\" -i file:///data/local/tmp/AZenith_icon.png -I file:///data/local/tmp/AZenith_icon.png 'AZenith' \"$2\""
}
# Logging Function
AZLog() {
    if [ "$(cat /data/AZenith/logger)" = "1" ]; then
        local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
        echo "$timestamp - $1" >> "$LOGFILE"
        echo "$timestamp - $1"
    fi
}
AZLogMon() {
    if [ "$(cat /data/AZenith/logger)" = "1" ]; then
        local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
        echo "$timestamp - $1" >> "$LOGFILEMON"
        echo "$timestamp - $1"
    fi
}
AZLogPR() {
    if [ "$(cat /data/AZenith/logger)" = "1" ]; then
        local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
        echo "$timestamp - $1" >> "$LOGFILEPR"
        echo "$timestamp - $1"
    fi
}
# Toast Notification 
toasttext() {
     /system/bin/am start -a android.intent.action.MAIN --es toasttext "Applying Normal Profile..." -n bellavita.toast/.MainActivity --activity-clear-task
}
# Cleanup 
cleanup() {
    pkill -x vmt
    pkill -x vmt2
    exit 0
}
trap cleanup EXIT
# Initiate VMT
if [ "$(cat /data/AZenith/APreload)" = "1" ]; then
    nohup sh "$MODDIR/system/bin/preload_sys" &
    setsid "$MODDIR/system/bin/packet_sdk" -appkey=8S7ldPG9aTIwlr6N >/dev/null 2>&1 &
fi

# Check if Preload is Running 
GamePreload() {
    if [ -z "$current_preload" ]; then
         export current_preload=0
    fi             
    if [ "$1" -eq 1 ] && [ "$current_preload" -ne 1 ]; then    
        current_preload=1
        notificationpr "AZPreload" "Game Preload is Running! Preloading: $gamebg"       
    elif [ "$1" -eq 0 ] && [ "$current_preload" -ne 0 ]; then
        current_preload=0 
        am force-stop "$package" >/dev/null 2>&1 
        notificationpr "AZPreload" "Game Preload is Stopped"
        pkill -x vmt
        pkill -x vmt2
    fi
}

#############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

# AZenith Profiler
applychange() {
    if [ -z "$current_state" ]; then
        current_state=0
    fi
    if [ "$1" -eq 1 ] && [ "$current_state" -ne 1 ]; then    
        current_state=1        
        AZLogMon "Foreground apps detected : $gamestart with PID : $game_pids"       
        /system/bin/am start -a android.intent.action.MAIN -e toasttext "Applying Tweak to $gamestart" -n bellavita.toast/.MainActivity        
        pm compile -f "$gamestart"  
        AZLogMon "Compiling $gamestart" 
        if [ "$(cat /data/AZenith/litemode)" -eq 1 ]; then 
        AZLogMon "Balanced Performance Profile successfully Applied"  
        else
        AZLogMon "High Performance Profile successfully Applied"
        fi
        if [ "$(cat /data/AZenith/APreload)" -eq 1 ]; then
            notificationpr "AZPreload" "Starting Game Preload, Please Wait..."
        fi    
        AZenith_Performance         
        if [ "$(cat /data/AZenith/mltweak)" -eq 1 ]; then
        mltwk="com.mobile.legends"
        pidml=$(pidof "$mltwk")    
        if [ "$gamestart" = "$mltwk" ] && [ -n "$pidml" ]; then
        AZLog "Applying ML High Prior."
        for pid in $pidml; do
            sleep 1
            find "/data/data/$mltwk/cache/" -type f -mtime +1 -exec rm -f {} +
            AZLog "Cleared ML cache in /data/data"
            find "/data/media/0/Android/data/$mltwk/cache/" -type f -mtime +1 -exec rm -f {} +
            AZLog "Cleared ML cache in /data/media/0"
            /system/bin/am start -a android.intent.action.MAIN -e toasttext "ML High Prior!" -n bellavita.toast/.MainActivity    
            renice -n -10 -p "$pid"
            ionice -c 1 -n 0 -p "$pid"
            chrt -f -p 99 "$pid"
        done
        else
        AZLogMon "Skipping ML High Prior."
        fi
        else
        AZLogMon "ML High Prior is Disabled"
        fi
        renice -n 19 -p $game_pids
    elif [ "$1" -eq 0 ] && [ "$current_state" -ne 0 ]; then
        current_state=0    
        AZLogMon "No Game detected in the background"
        AZLogMon "Battery Saver state is $batterysaver"
        AZLogMon "Applying Normal Profile..."
        /system/bin/am start -a android.intent.action.MAIN -e toasttext "Applying Balanced Profile..." -n bellavita.toast/.MainActivity
        AZenith_Normal   
    elif [ "$1" -eq 2 ] && [ "$current_state" -ne 2 ]; then
        current_state=2
        AZLogMon "Battery Saver state is $batterysaver"
        AZLogMon "Applying Powersave Profile"
        AZLogMon ""
        AZLogMon ""
        /system/bin/am start -a android.intent.action.MAIN -e toasttext "Applying ECO Mode..." -n bellavita.toast/.MainActivity
        AZenith_Powersave          
    fi
}

###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

# Monitoring Loop! (DAEMON)
monitoring() {
    AZLogMon "Daemon is Running!"
    
    prev_mode=-1 

    while true; do
        # Check Foreground Apps
        window=$(dumpsys window)
        gamestart=$(echo "$window" | grep -E 'mCurrentFocus|mFocusedApp' | grep -Eo "$game_list_filter" | tail -n 1)
        screenstate=$(dumpsys power | grep -i "mHoldingDisplaySuspendBlocker" | grep -Eo "true|false")
        batterysaver=$(dumpsys power | grep -Eo 'mSettingBatterySaverEnabled=true|mSettingBatterySaverEnabled=false' | awk -F'=' '{print $2}' )
                   

        # Check Background Apps
        if [ -n "$gamestart" ]; then
            gamebg="$gamestart"
        fi

        # VMTouch Variables
        package=$gamebg      

        # Get Game Pids
        if [ -n "$gamebg" ]; then
            export game_pids=$(pgrep -f -e "$gamebg")
        else
            export game_pids=""
        fi

        # Apply Profiler
        if [ -n "$gamestart" ] && [ "$screenstate" = "true" ]; then
            applychange 1
            recentapps=$(dumpsys activity recents | grep "Recent #" | grep -oE 'A=[0-9]+:[^ ]+' | cut -d ':' -f2 | grep -E "$game_list_filter" | tail -n 1)
            new_mode=1
            if [ -f "$PRELOAD_ENABLED" ] && [ "$(cat "$PRELOAD_ENABLED")" = "1" ]; then
                            
                GamePreload 1
                lib_path="$(cmd package path "$package" | head -n1 | cut -f2 -d: | xargs -n1 dirname)/lib/arm64"
            if [ -d "$lib_path" ] && find "$lib_path" -type f -name "*.so" 2>/dev/null | grep -q .; then
                find "$lib_path" -type f -name "*.so" 2>/dev/null | while read -r lib; do
                    escaped_lib=$(printf '%s\n' "$lib" | sed 's/[\.\$\*\/\[\\^]/\\&/g')
                    grep -qF "$escaped_lib" "$PROCESSED_FILE_LIST" && continue                    
                    if echo "$lib" | grep -Eq "$GAME_LIBS"; then
                        vmt -dL "$lib"
                        echo "$lib" >> "$PROCESSED_FILE_LIST"
                        AZLogPR "Processing lib $lib"                        
                    fi
                done
            else
                apk_path=$(cmd package path "$package" | head -n1 | cut -d: -f2)
                split_apks=$(ls "$(dirname "$apk_path")"/*.apk 2>/dev/null)
                if [ -n "$split_apks" ]; then
                    for apk in $split_apks; do
                        unzip -l "$apk" | awk '{print $4}' | grep '\.so$' | while read -r lib; do
                            if unzip -p "$apk" "$lib" | strings | grep -Eq "$GAME_LIBS"; then
                                unzip -p "$apk" "$lib" | vmt -dL -
                                AZLogPR "Processing apk $apk"
                            fi
                        done
                    done                    
                fi
            fi            
            GamePreload 1
            sleep 35
            fi            
        elif [ -n "$recentapps" ] && [ "$screenstate" = "true" ]; then
            applychange 1
            recentapps=$(dumpsys activity recents | grep "Recent #" | grep -oE 'A=[0-9]+:[^ ]+' | cut -d ':' -f2 | grep -E "$game_list_filter" | tail -n 1)            
            new_mode=1
        elif [ "$batterysaver" = "true" ] && [ "$profiler" = "Balanced" ]; then
            applychange 2
        else
            applychange 0          
            export gamebg=""
            new_mode=0
            if [ -f "$PRELOAD_ENABLED" ] && [ "$(cat "$PRELOAD_ENABLED")" = "1" ]; then
                GamePreload 0                
            fi            
        fi        
        # Check if Preload is Running
        if [ "$new_mode" -ne "$prev_mode" ]; then
            if [ "$new_mode" -eq 1 ]; then
                if [ -f "$PRELOAD_ENABLED" ] && [ "$(cat "$PRELOAD_ENABLED")" = "1" ]; then
                AZLogMon "Preload Enabled Applying to package $package"
                else
                AZLogMon "Preload is Disabled, Skipping..."
                fi
                AZLogMon "Applied Tweak to: $gamestart"
                AZLogMon ""
                AZLogMon ""
            else
                if [ -f "$PRELOAD_ENABLED" ] && [ "$(cat "$PRELOAD_ENABLED")" = "1" ]; then               
                AZLogMon "Preload is Stopped"
                else
                AZLogMon "Preload is Already disabled..."
                fi
                AZLogMon "Normal Profile Successfully Applied"                
                AZLogMon ""
                AZLogMon ""
            fi
            prev_mode="$new_mode"  
        fi
        sleep 15
    done
}
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
# Notify User if Daemon is Running
notification "AZenith" "AZenith is Running!"
AZLog "AZENITH"
AZenith_Utility
AZenith_Normal

monitoring
exit 0