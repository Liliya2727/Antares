#!/bin/sh

#
# Copyright (C) 2024-2025 Zexshia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

MODDIR=${0%/*}
logpath="/data/AZenith/AZenith.log"
POWERSAVE_GOV_FILE="/data/AZenith/custom_powersave_cpu_gov"

AZLog() {
    if [ "$(cat /data/AZenith/logger)" = "1" ]; then
        local timestamp
        timestamp=$(date +'%Y-%m-%d %H:%M:%S')
        local message="$1"
        echo "$timestamp - $message" >> "$logpath"
        echo "$timestamp - $message"
    fi
}

zeshia() {
    local value="$1"
    local path="$2"
    if [ ! -e "$path" ]; then
        AZLog "File $path not found, skipping..."
        return
    fi
    if [ ! -w "$path" ] && ! chmod 666 "$path" 2>/dev/null; then
        AZLog "Cannot write to $path (permission denied)"
        return
    fi
    echo "$value" > "$path" 2>/dev/null
    local current
    current="$(cat "$path" 2>/dev/null)"
    if [ "$current" = "$value" ]; then
        AZLog "Set $path to $value"
    else
        echo "$value" > "$path" 2>/dev/null
        current="$(cat "$path" 2>/dev/null)"
        if [ "$current" = "$value" ]; then
            AZLog "Set $path to $value (after retry)"
        else
            AZLog "Wrote to $path, but fallback different values (output: $current)"
        fi
    fi
    chmod 644 "$path" 2>/dev/null
}


####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
# Set Profiler
zeshia "ECO Mode" "/data/AZenith/profiler"

# Load Governor
load_powersave_governor() {
    if [ -f "$POWERSAVE_GOV_FILE" ]; then
        cat "$POWERSAVE_GOV_FILE"
    else
        echo "powersave"  
    fi
}
powersave_cpu_gov=$(load_powersave_governor)
AZLog "Powersave CPU Governor: $powersave_cpu_gov"

# Change governor to Custom Powersave Governor
changegovernor() {
for path in /sys/devices/system/cpu/cpu*/cpufreq; do
    zeshia "$powersave_cpu_gov" "$path/scaling_governor"
    sleep 0.5
done
}
changegovernor 


# PPM Settings
if [ -d /proc/ppm ]; then
    if [ -f /proc/ppm/policy_status ]; then
        for idx in $(grep -E 'FORCE_LIMIT|PWR_THRO|THERMAL|USER_LIMIT' /proc/ppm/policy_status | awk -F'[][]' '{print $2}'); do
            zeshia "1" "/proc/ppm/policy_status"
        done
        
        for dx in $(grep -E 'SYS_BOOST' /proc/ppm/policy_status | awk -F'[][]' '{print $2}'); do
            zeshia "0" "/proc/ppm/policy_status"
        done
    fi
fi

# Power level settings
for pl in /sys/devices/system/cpu/perf; do
    zeshia 0 "$pl/gpu_pmu_enable"
    zeshia 0 "$pl/fuel_gauge_enable"
    zeshia 0 "$pl/enable"
    zeshia 1 "$pl/charger_enable"
done

# Disable DND
if [ "$(cat /data/AZenith/dnd)" -eq 1 ]; then
    cmd notification set_dnd off && AZLog "DND disabled" || AZLog "Failed to disable DND"
else
    AZLog "DND was already off."
fi

# CPU Freq Limiter
limiter=$(cat /data/AZenith/customFreqOffset | sed -e 's/OFF/100/' -e 's/%//g')
AZLog "Cpu limit is set to $limiter"

# Limit cpu freq
cpufrequency() {
    if [ -d /proc/ppm ]; then
        cluster=0
        for path in /sys/devices/system/cpu/cpufreq/policy*; do
            cpu_maxfreq=$(cat "$path/cpuinfo_max_freq")

            new_maxfreq=$((cpu_maxfreq * $limiter / 100))
            new_minfreq=$((cpu_maxfreq * 40 / 100))

            zeshia "$cluster $new_maxfreq" "/proc/ppm/policy/hard_userlimit_max_cpu_freq"
            zeshia "$cluster $new_minfreq" "/proc/ppm/policy/hard_userlimit_min_cpu_freq"
            ((cluster++))
        done
    fi

  
    for path in /sys/devices/system/cpu/cpufreq/policy*; do
        [ -f "$path/cpuinfo_max_freq" ] || continue
        cpu_maxfreq=$(cat "$path/cpuinfo_max_freq")

        new_maxfreq=$((cpu_maxfreq * $limiter / 100))
        new_minfreq=$((cpu_maxfreq * 40 / 100))

        zeshia "$new_maxfreq" "$path/scaling_max_freq"
        zeshia "$new_minfreq" "$path/scaling_min_freq"
    done
}
cpufrequency

# Cache Pressure
zeshia "30" "/proc/sys/vm/vfs_cache_pressure"

# Restore UFS Governor
for path in /sys/class/devfreq/*.ufshc; do
    zeshia "simple_ondemand" "$path/governor"
    
done

# cpufreq cci
zeshia "0" "/proc/cpufreq/cpufreq_cci_mode"
zeshia "1" "/proc/cpufreq/cpufreq_power_mode"


# GPU Frequency
if [ -d /proc/gpufreq ]; then
		zeshia "0" /proc/gpufreq/gpufreq_opp_freq
elif [ -d /proc/gpufreqv2 ]; then
		zeshia "-1" /proc/gpufreqv2/fix_target_opp_index
fi

# UFS governor 
zeshia "0" "/sys/devices/platform/10012000.dvfsrc/helio-dvfsrc/dvfsrc_req_ddr_opp"         
zeshia "0" "/sys/kernel/helio-dvfsrc/dvfsrc_force_vcore_dvfs_opp"                          
zeshia "powersave" "/sys/class/devfreq/mtk-dvfsrc-devfreq/governor"                      
zeshia "powersave" "/sys/devices/platform/soc/1c00f000.dvfsrc/mtk-dvfsrc-devfreq/devfreq/mtk-dvfsrc-devfreq/governor"

# GPU Power limiter - Performance mode (not for Powersave)
[ -f "/proc/gpufreq/gpufreq_power_limited" ] && {
	for setting in ignore_batt_oc ignore_batt_percent ignore_low_batt ignore_thermal_protect ignore_pbm_limited; do
		zeshia "$setting 1" /proc/gpufreq/gpufreq_power_limited
	done
}

# Disable PBM
zeshia "stop 1" /proc/pbm/pbm_stop

# Enable battery current limiter
zeshia "stop 1" /proc/mtk_batoc_throttling/battery_oc_protect_stop

# Workqueue settings
zeshia "Y" /sys/module/workqueue/parameters/power_efficient
zeshia "Y" /sys/module/workqueue/parameters/disable_numa
zeshia "1" /sys/kernel/eara_thermal/enable
zeshia "1" /sys/devices/system/cpu/eas/enable

#Disable CPU in Powersave
zeshia "0" /sys/devices/system/cpu/cpu2/online

# Adaptive power saver
cmd power set-adaptive-power-saver-enabled true
cmd power set-fixed-performance-mode-enabled false

zeshia 30 /proc/sys/kernel/perf_cpu_time_max_percent
zeshia 1 /proc/sys/kernel/sched_energy_aware

#  Enable battery saver module    
[ -f /sys/module/battery_saver/parameters/enabled ] && {    
	if grep -qo '[0-9]\+' /sys/module/battery_saver/parameters/enabled; then    
		zeshia 1 /sys/module/battery_saver/parameters/enabled    
	else    
		zeshia Y /sys/module/battery_saver/parameters/enabled    
	fi    
}    
 

# Schedfeature settings - Powersave Mode
if [ -f "/sys/kernel/debug/sched_features" ]; then  
	zeshia NO_NEXT_BUDDY /sys/kernel/debug/sched_features     
	zeshia NO_TTWU_QUEUE /sys/kernel/debug/sched_features    
fi

bypassCharge

AZLog "ECO Mode applied successfully!"

exit 0
####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################