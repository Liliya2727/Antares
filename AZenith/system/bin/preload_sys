#!/system/bin/sh

#
# Copyright (C) 2024-2025 Zexshia
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################
# Paths
BASEDIR="/data/adb/modules/AZenith"
INT="/data/AZenith"
RWD="$INT"
MSC="$BASEDIR"
SEARCH_PATHS="/vendor/lib64/egl /vendor/lib64/hw"
PROCESSED_FILE_LIST="$RWD/processed_files.txt"
LOGFILE="/data/AZenith/AZenith.log"
PRELOAD_ENABLED="/data/AZenith/APreload"

GPU_LIBS='libEGL_mtk\.so|libGLESv[12]_CM_mtk\.so|libGLES_meow\.so|libMEOW_(data|gift|trace)\.so|eglSubDriverAndroid\.so|libQTapGLES\.so|libMEOW_qt\.so|libEGL_adreno\.so|libGLESv[12]_CM_adreno\.so|libq3dtools_(adreno|esx)\.so|libVkLayer_ADRENO_qprofiler\.so|libEGL_POWERVR_ROGUE\.so|libGLESv[12]_CM_POWERVR_ROGUE\.so|libGLES_mali\.so'
VULKAN_LIBS='vulkan\.universal7904\.so|vulkan\.mali\.so|vulkan\.universal9825_r\.so|vulkan\.mt6765\.so|vulkan\.adreno\.so'

echo "Starting script..."

mkdir -p "$RWD"
touch "$PROCESSED_FILE_LIST"

find $SEARCH_PATHS -type f | while read -r file; do
    [ ! -f "$file" ] && continue

    grep -qxF "$file" "$PROCESSED_FILE_LIST" && continue

    if strings "$file" | grep -Eq "$GPU_LIBS|$VULKAN_LIBS"; then
        vmt2 -dL "$file"
        echo "$file" >> "$PROCESSED_FILE_LIST"
    fi
done


for lib in $(find /*/lib64 -type f ); do
    grep -qxF "$lib" "$PROCESSED_FILE_LIST" && continue

    if strings "$lib" | grep -Eo 'GPU|GLES|opengl|vulkan' ; then
        vmt2 -dL "$lib"
        echo "$lib" >> "$PROCESSED_FILE_LIST"
    fi
done