#!/bin/sh

# Generate game list filter
game_list_filter="com.example.gamelist1|com.example.gamelist2$(awk '!/^[[:space:]]*$/ && !/^#/ && !(/[[:alnum:]]+[[:space:]]+[[:alnum:]]+[[:space:]]+[[:alnum:]]+/) {sub("-e ", ""); printf "|%s", $0}' "/data/Antares/gamelist.txt")"

cpu_cores=$(($(nproc --all) - 1))

# Path to reboot flag
REBOOT_FLAG="/data/local/tmp/reboot_flag"

check_reboot() {
    if [ ! -f "$REBOOT_FLAG" ]; then
        sleep 15
        su -lp 2000 -c "/system/bin/cmd notification post -t '𝐀𝐍𝐓𝐀𝐑𝐄𝐒!' -i file:///data/local/tmp/antares.png -I file:///data/local/tmp/antares.png 'antares' '𝙏𝙬𝙚𝙖𝙠 𝙞𝙨 𝘼𝙥𝙥𝙡𝙞𝙚𝙙!'" >/dev/null &

        touch "$REBOOT_FLAG"
        sleep 3
        rm -rf "$REBOOT_FLAG"
    fi
}

# Path to store default governor before modifying
DEFAULT_GOV_FILE="/data/local/tmp/default_cpu_gov"

# Function to retrieve current CPU governor
get_default_governor() {
    for path in /sys/devices/system/cpu/cpufreq/policy*; do
        cat "$path/scaling_governor"
        break  # Only store the governor from the first policy (assuming they are all the same)
    done
}

# Function to store the default governor
store_default_governor() {
    if [ ! -f "$DEFAULT_GOV_FILE" ]; then
        get_default_governor > "$DEFAULT_GOV_FILE"
    fi
}

# Function to retrieve the stored governor
load_default_governor() {
    if [ -f "$DEFAULT_GOV_FILE" ]; then
        cat "$DEFAULT_GOV_FILE"
    else
        echo "schedutil"  # Fallback to a common default governor
    fi
}

# Function to write values to sysfs/proc files
zeshia() {
	if [ -f $2 ]; then
		chmod 644 $2 >/dev/null 2>&1
		echo $1 >$2 2>/dev/null
		chmod 444 $2 >/dev/null 2>&1
	fi
}

change_permission() {
	if [ -f $2 ]; then
		chmod $1 $2
	fi
}

# Enable Tweak
startgamemode() {
    store_default_governor  # Store default governor before modifying

    # Force CPU to Performance mode
    for path in /sys/devices/system/cpu/cpufreq/policy*; do
        zeshia performance "$path/scaling_governor"
    done &
    
	zeshia 1 /sys/devices/system/cpu/cpu1/online

	if [ -d /proc/ppm ]; then
		cluster=0
		for path in /sys/devices/system/cpu/cpufreq/policy*; do
			cpu_maxfreq=$(cat $path/cpuinfo_max_freq)
			zeshia "$cluster $cpu_maxfreq" /proc/ppm/policy/hard_userlimit_max_cpu_freq
			zeshia "$cluster $cpu_maxfreq" /proc/ppm/policy/hard_userlimit_min_cpu_freq
			((cluster++))
		done
	fi

	change_permission 644 /sys/devices/virtual/thermal/thermal_message/cpu_limits
	for path in /sys/devices/system/cpu/*/cpufreq; do
		cpu_maxfreq=$(cat $path/cpuinfo_max_freq)
		zeshia "$cpu_maxfreq" $path/scaling_max_freq
		zeshia "$cpu_maxfreq" $path/scaling_min_freq
		zeshia "cpu$(awk '{print $1}' $path/affected_cpus) $cpu_maxfreq" /sys/devices/virtual/thermal/thermal_message/cpu_limits
	done
	change_permission 000 /sys/devices/virtual/thermal/thermal_message/cpu_limits

	# GPU Frequency
	if [ -d /proc/gpufreq ]; then
		gpu_freq="$(cat /proc/gpufreq/gpufreq_opp_dump | grep -o 'freq = [0-9]*' | sed 's/freq = //' | sort -nr | head -n 1)"
		zeshia "$gpu_freq" /proc/gpufreq/gpufreq_opp_freq
	elif [ -d /proc/gpufreqv2 ]; then
		zeshia 0 /proc/gpufreqv2/fix_target_opp_index
	fi

	# Disable GPU Power limiter
	if [ -f "/proc/gpufreq/gpufreq_power_limited" ]; then
		zeshia "ignore_batt_oc 1" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_batt_percent 1" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_low_batt 1" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_thermal_protect 1" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_pbm_limited 1" /proc/gpufreq/gpufreq_power_limited
	fi

	# DRAM Frequency
	if [ ! $(uname -r | cut -d'.' -f1,2 | sed 's/\.//') -gt 500 ]; then
		echo 0 >/sys/devices/platform/10012000.dvfsrc/helio-dvfsrc/dvfsrc_req_ddr_opp
	else
		echo 0 >/sys/kernel/helio-dvfsrc/dvfsrc_force_vcore_dvfs_opp
	fi
		# Memory tweak
	zeshia 80 /proc/sys/vm/vfs_cache_pressure

	# UFS governor
	for path in /sys/class/devfreq/*.ufshc; do
		zeshia performance $path/governor
	done &
	for path in /sys/class/devfreq/mmc*; do
		zeshia performance $path/governor
	done &
	
zeshia -8 /proc/eem/EEM_DET_B/eem_offset
zeshia -8 /proc/eem/EEM_DET_BL/eem_offset
zeshia -8 /proc/eem/EEM_DET_L/eem_offset
zeshia -4 /proc/eem/EEM_DET_CCI/eem_offset
zeshia -1 /proc/eemg/EEMG_DET_GPU/eemg_offset
zeshia -1 /proc/eemg/EEMG_DET_GPU_HI/eemg_offset
}

# Disable Tweak
stopgamemode() {
    default_cpu_gov=$(load_default_governor)  # Retrieve stored governor

    # Restore original CPU governor
    for path in /sys/devices/system/cpu/cpufreq/policy*; do
        zeshia "$default_cpu_gov" "$path/scaling_governor"
    done &
    
    # Cleanup stored governor file
    rm -f "$DEFAULT_GOV_FILE"
   
   zeshia 1 /sys/devices/system/cpu/cpu1/online

	if [ -d /proc/ppm ]; then
		cluster=0
		for path in /sys/devices/system/cpu/cpufreq/policy*; do
			cpu_maxfreq=$(cat $path/cpuinfo_max_freq)
			cpu_minfreq=$(cat $path/cpuinfo_min_freq)
			zeshia "$cluster $cpu_maxfreq" /proc/ppm/policy/hard_userlimit_max_cpu_freq
			zeshia "$cluster $cpu_minfreq" /proc/ppm/policy/hard_userlimit_min_cpu_freq
			((cluster++))
		done
	fi

	# GPU Frequency
	if [ -d /proc/gpufreq ]; then
		zeshia "0" /proc/gpufreq/gpufreq_opp_freq 2>/dev/null
	elif [ -d /proc/gpufreqv2 ]; then
		zeshia -1 /proc/gpufreqv2/fix_target_opp_index
	fi

	# Disable GPU Power limiter
	if [ -f "/proc/gpufreq/gpufreq_power_limited" ]; then
		zeshia "ignore_batt_oc 0" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_batt_percent 0" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_low_batt 0" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_thermal_protect 0" /proc/gpufreq/gpufreq_power_limited
		zeshia "ignore_pbm_limited 0" /proc/gpufreq/gpufreq_power_limited
	fi
	

	for path in /sys/devices/system/cpu/*/cpufreq; do
		cpu_maxfreq=$(cat $path/cpuinfo_max_freq)
		cpu_minfreq=$(cat $path/cpuinfo_min_freq)
		zeshia "$cpu_maxfreq" $path/scaling_max_freq
		zeshia "$cpu_minfreq" $path/scaling_min_freq
	done
	change_permission 644 /sys/devices/virtual/thermal/thermal_message/cpu_limits

	# Disable Power Budget management for new 5.x kernels
	zeshia "stop 0" /proc/pbm/pbm_stop

	# Disable battery current limiter
	zeshia "stop 0" /proc/mtk_batoc_throttling/battery_oc_protect_stop

	# DRAM Frequency
	if [ ! $(uname -r | cut -d'.' -f1,2 | sed 's/\.//') -gt 500 ]; then
		echo -1 >/sys/devices/platform/10012000.dvfsrc/helio-dvfsrc/dvfsrc_req_ddr_opp
	else
		echo -1 >/sys/kernel/helio-dvfsrc/dvfsrc_force_vcore_dvfs_opp
	fi

	# Memory Tweaks
	zeshia 120 /proc/sys/vm/vfs_cache_pressure

	# UFS governor
	for path in /sys/class/devfreq/*.ufshc; do
		zeshia simple_ondemand $path/governor
	done &
	for path in /sys/class/devfreq/mmc*; do
		zeshia simple_ondemand $path/governor
	done &
	
zeshia -14 /proc/eem/EEM_DET_B/eem_offset
zeshia -14 /proc/eem/EEM_DET_BL/eem_offset
zeshia -14 /proc/eem/EEM_DET_L/eem_offset
zeshia -9 /proc/eem/EEM_DET_CCI/eem_offset
zeshia -2 /proc/eemg/EEMG_DET_GPU/eemg_offset
zeshia -2 /proc/eemg/EEMG_DET_GPU_HI/eemg_offset
}

# apply mode based on game detection
apply_mode() {

    # Ensure cur_mode is initialized
    if [ -z "$cur_mode" ]; then
        export cur_mode=0
    fi

        if [ "$1" -eq 1 ] && [ "$cur_mode" -ne 1 ]; then
            export cur_mode=1
            renice -n -20 -p $pid
		    ionice -c 2 -n 0 -p $pid
		    sleep 5
            /system/bin/am start -a android.intent.action.MAIN -e toasttext "Applying Antares!" -n bellavita.toast/.MainActivity
            sleep 2
            startgamemode 
    elif [ "$1" -eq 0 ] && [ "$cur_mode" -ne 0 ]; then
        export cur_mode=0
        sleep 10
        /system/bin/am start -a android.intent.action.MAIN -e toasttext "Disable Gamemode..." -n bellavita.toast/.MainActivity
        sleep 2
        stopgamemode
        zeshtweak
    fi
}

zeshtweak() {
echo "schedhorizon" > "/sys/devices/system/cpu/cpufreq/policy0/scaling_governor"
echo "schedhorizon" > "/sys/devices/system/cpu/cpufreq/policy4/scaling_governor"
echo "schedhorizon" > "/sys/devices/system/cpu/cpufreq/policy7/scaling_governor"

# Core Ctl Optimisation
echo "1" > /sys/devices/system/cpu/cpu0/core_ctl/enable
echo "6" > /sys/devices/system/cpu/cpu0/core_ctl/min_cpus
echo "6" > /sys/devices/system/cpu/cpu0/core_ctl/max_cpus
echo "10" > /sys/devices/system/cpu/cpu0/core_ctl/offline_throttle_ms
echo "1" > /sys/devices/system/cpu/cpu4/core_ctl/enable
echo "4" > /sys/devices/system/cpu/cpu4/core_ctl/min_cpus
echo "4" > /sys/devices/system/cpu/cpu4/core_ctl/max_cpus
echo "10" > /sys/devices/system/cpu/cpu4/core_ctl/offline_throttle_ms
echo "10" > /sys/devices/system/cpu/cpu4/core_ctl/btask_up_thresh
echo "2" > /sys/devices/system/cpu/cpu4/core_ctl/btask_down_thresh
echo "1" > /sys/devices/system/cpu/cpu7/core_ctl/enable
echo "2" > /sys/devices/system/cpu/cpu7/core_ctl/min_cpus
echo "2" > /sys/devices/system/cpu/cpu7/core_ctl/max_cpus
echo "10" > /sys/devices/system/cpu/cpu7/core_ctl/offline_throttle_ms
echo "10" > /sys/devices/system/cpu/cpu7/core_ctl/btask_up_thresh
echo "2" > /sys/devices/system/cpu/cpu7/core_ctl/btask_down_thresh
echo "90" > /sys/devices/system/cpu/cpu7/core_ctl/cpu_tj_btask_thresh

# FPSGO Configuration 
echo "2" > /sys/power/pnpmgr/fpsgo_boost/boost_enable
echo "5" > /sys/module/fbt_cpu/parameters/bhr_opp
echo "5" > /sys/module/fbt_cpu/parameters/bhr_opp_l
echo "5" > /sys/module/fbt_cpu/parameters/boost_affinity
echo "240" > /sys/module/fbt_cpu/parameters/fps_level_range
echo "2" > /sys/module/xgf/parameters/xgf_uboost
echo "180" > /sys/module/fbt_cpu/parameters/uboost_enhance_f
echo "5" > /sys/module/fbt_cpu/parameters/gcc_fps_margin
echo "100" > /sys/module/fbt_cpu/parameters/rescue_enhance_f
echo "2" > /sys/module/fbt_cpu/parameters/qr_mod_frame
echo "240" > /sys/power/pnpmgr/fpsgo_boost/fstb/fstb_fix_fps
echo "90" > /sys/kernel/fpsgo/fstb/fstb_tune_quantile
echo "0" > /sys/power/pnpmgr/fpsgo_boost/fstb/fstb_tune_error_threshold
echo "2" > /sys/power/pnpmgr/fpsgo_boost/fstb/margin_mode
echo "5" > /sys/power/pnpmgr/fpsgo_boost/fbt/bhr_opp
echo "2" > /sys/power/pnpmgr/fpsgo_boost/fbt/adjust_loading
echo "2" > /sys/power/pnpmgr/fpsgo_boost/fbt/dyn_tgt_time_en
echo "5" > /sys/power/pnpmgr/fpsgo_boost/fbt/floor_opp
echo "50" > /sys/power/pnpmgr/fpsgo_boost/fbt/rescue_enhance_f
echo "30" > /sys/module/fbt_cpu/parameters/rescue_opp_c
echo "20" > /sys/module/fbt_cpu/parameters/rescue_opp_f
echo "90" > /sys/module/fbt_cpu/parameters/rescue_percent
echo "2" > /sys/power/pnpmgr/fpsgo_boost/fbt/ultra_rescue
echo "2" > /sys/kernel/fpsgo/fbt/boost_ta

# Ged Optimisation
echo "1" > /sys/module/ged/parameters/gx_game_mode
echo "1" > /sys/module/ged/parameters/ged_smart_boost
echo "1" > /sys/module/ged/parameters/cpu_boost_policy
echo "1" > /sys/module/ged/parameters/boost_extra
echo "886000" > /sys/module/ged/parameters/gpu_cust_upbound_freq
echo "1" > /sys/module/ged/parameters/enable_gpu_boost
echo "1" > /sys/module/ged/parameters/ged_boost_enable
echo "1" > /sys/module/ged/parameters/gx_boost_on
echo "1" > /sys/module/ged/parameters/boost_gpu_enable
echo "1" > /sys/module/ged/parameters/ged_monitor_3D_fence_systrace
echo "90" > /sys/module/ged/parameters/g_fb_dvfs_threshold
echo "1" > /sys/module/ged/parameters/g_gpu_timer_based_emu
echo "1" > /sys/module/ged/parameters/gpu_cust_boost_freq
echo "1" > /sys/kernel/ged/hal/gpu_boost_level

# Volt Optimizer
echo "-14" > /proc/eem/EEM_DET_B/eem_offset
echo "-14" > /proc/eem/EEM_DET_BL/eem_offset
echo "-14" > /proc/eem/EEM_DET_L/eem_offset
echo "-9" > /proc/eem/EEM_DET_CCI/eem_offset
echo "-2" > /proc/eemg/EEMG_DET_GPU/eemg_offset
echo "-2" > /proc/eemg/EEMG_DET_GPU_HI/eemg_offset

# Schedul Optimisation
echo "500000" > /proc/sys/kernel/sched_migration_cost_ns
echo "30" > /proc/sys/kernel/perf_cpu_time_max_percent
echo "3" > /proc/sys/vm/drop_caches
echo "256" > /proc/sys/kernel/sched_nr_migrate
echo "10000000" > /proc/sys/kernel/sched_latency_ns
echo "1024" > /proc/sys/kernel/sched_util_clamp_max
echo "1024" > /proc/sys/kernel/sched_util_clamp_min
echo "1" > /proc/sys/kernel/sched_child_runs_first
echo "1" > /proc/sys/kernel/sched_tunable_scaling
echo "0" > /proc/sys/kernel/sched_energy_aware

# mmcblk0
echo "0" > /sys/block/mmcblk0/queue/add_random
echo "0" > /sys/block/mmcblk0/queue/iostats
echo "0" > /sys/block/mmcblk0/queue/nomerges
echo "0" > /sys/block/mmcblk0/queue/rotational
echo "2" > /sys/block/mmcblk0/queue/rq_affinity
echo "128" > /sys/block/mmcblk0/queue/nr_requests
echo "512" > /sys/block/mmcblk0/queue/read_ahead_kb

# Sda
echo "0" > /sys/block/sda/queue/add_random
echo "0" > /sys/block/sda/queue/iostats
echo "0" > /sys/block/sda/queue/nomerges
echo "0" > /sys/block/sda/queue/rotational
echo "2" > /sys/block/sda/queue/rq_affinity
echo "128" > /sys/block/sda/queue/nr_requests
echo "1024" > /sys/block/sda/queue/read_ahead_kb

# Sdb
echo "0" > /sys/block/sdb/queue/add_random
echo "0" > /sys/block/sdb/queue/iostats
echo "0" > /sys/block/sdb/queue/nomerges
echo "0" > /sys/block/sdb/queue/rotational
echo "2" > /sys/block/sdb/queue/rq_affinity
echo "128" > /sys/block/sdb/queue/nr_requests
echo "1024" > /sys/block/sdb/queue/read_ahead_kb

# Sdc
echo "0" > /sys/block/sdc/queue/add_random
echo "0" > /sys/block/sdc/queue/iostats
echo "0" > /sys/block/sdc/queue/nomerges
echo "0" > /sys/block/sdc/queue/rotational
echo "2" > /sys/block/sdc/queue/rq_affinity
echo "256" > /sys/block/sdc/queue/nr_requests
echo "1024" > /sys/block/sdc/queue/read_ahead_kb

# SET FREQ VOLTAGE
echo "6000000" > /sys/class/power_supply/battery/voltage_now
echo "1" > /sys/devices/system/cpu/perf/enable

# Schedhorizon Tunes
echo "50 100 200 400 600" > /sys/devices/system/cpu/cpufreq/policy0/schedhorizon/up_delay
echo "500000 850000 1250000 1450000 1800000" > /sys/devices/system/cpu/cpufreq/policy0/schedhorizon/efficient_freq
echo "50 100 200 400 600 800" > /sys/devices/system/cpu/cpufreq/policy4/schedhorizon/up_delay
echo "437000 902000 1162000 1451000 1740000 1985000" > /sys/devices/system/cpu/cpufreq/policy4/schedhorizon/efficient_freq
echo "30 50 150 300 500 700" > /sys/devices/system/cpu/cpufreq/policy7/schedhorizon/up_delay
echo "659000 1108000 1370000 1632000 1820000 2284000" > /sys/devices/system/cpu/cpufreq/policy7/schedhorizon/efficient_freq

# Mediatek 5.10 kernel tweaks
echo "simple_ondemand" > "/sys/devices/platform/soc/13000000.mali/devfreq/13000000.mali/governor"

### Based on Encore tweaks
echo "0 0 0 0" > "/proc/sys/kernel/printk"
echo "off" > "/proc/sys/kernel/printk_devkmsg"
echo "0" > "/proc/sys/kernel/sched_schedstats"
echo "20" > "/proc/sys/kernel/perf_cpu_time_max_percent"
}

# Monitoring function for game detection
monitoring() {
	while true; do
		window=$(dumpsys window)
		gamestart=$(echo "$window" | grep -E 'mCurrentFocus|mFocusedApp' | grep -Eo "$game_list_filter" | tail -n 1)
		screenoff=$(echo "$window" | grep "mScreen" | grep -Eo "false" | tail -n 1)

		if [ -n "$gamestart" ] && [ "$screenoff" != "false" ]; then
			pid=$(pgrep -f "$gamestart")
			apply_mode 1 # Enable Tweak
		else
			apply_mode 0 # Disable Tweak
		fi
	sleep 5
done		
}

# Run reboot check before starting monitoring
check_reboot

# Start Applying Tweak
zeshtweak

# Start monitoring games
monitoring






#This Shell Script is OpenSource, you can edit it if you want don't forget to Credit @Zexshia
